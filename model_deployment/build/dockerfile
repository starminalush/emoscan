# BUILDING PYTHON PACKAGES
FROM python:3.10-slim AS python-builder

RUN apt update && \
    apt install --no-install-recommends -y build-essential  libglib2.0-0  libgl1-mesa-glx  libsm6 libxrender1 libxext6 gcc make
RUN pip install --upgrade pip
COPY ./requirements.txt .
RUN pip install -U --no-cache-dir -r requirements.txt
RUN pip install https://github.com/KaiyangZhou/deep-person-reid/archive/master.zip


# BUILDING RUNTIME
FROM nvcr.io/nvidia/cuda:11.6.0-cudnn8-devel-ubuntu20.04
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
RUN apt update
RUN apt install software-properties-common -y && add-apt-repository ppa:deadsnakes/ppa
RUN apt install -y  --no-install-recommends  build-essential libglib2.0-0  libgl1-mesa-glx  libsm6 libxrender1 libxext6 python3.10 python3.10-distutils gcc
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 2 && \
    update-alternatives --install /usr/bin/python python /usr/bin/python3 1
RUN  apt clean && rm -rf /var/lib/apt/lists/*
COPY --from=python-builder /root/.local/lib/python3.10/site-packages /usr/local/lib/python3.10/dist-packages
ENV PATH=/usr/local/cuda-11.6/bin:$PATH
ENV LD_LIBRARY_PATH=/usr/local/cuda-11.6/lib64:$LD_LIBRARY_PATH
WORKDIR /app
