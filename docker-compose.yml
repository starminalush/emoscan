version: "2.4"
services:
  frontend:
    build: ./frontend/build

    volumes:
      - .frontend/app:/app

    restart: always
    env_file:
      - .env

    ports:
      - "${FRONTEND_PORT}:8080"

    networks:
      - internal-network

  backend:
    build: ./backend/build

    volumes:
      - ./backend/app:/app
    restart: always

    env_file:
      - .env
      - ./backend/.env

    ports:
      - "${BACKEND_PORT}:8000"
    networks:
      - internal-network

  model_deployment:
    build: ./model_deployment/build
    runtime: nvidia
    shm_size: '6gb'

    volumes:
      - ./model_deployment/app:/app
    restart: on-failure
    env_file:
      - .env
      - ./model_deployment/.env

    ports:
      - "${MODEL_DEPLOYMENT_PORT}:8000"
    command: serve run --host 0.0.0.0 main:backend

    networks:
      - internal-network

networks:
  internal-network:
    name: mfdp-2023_default
    external: True
